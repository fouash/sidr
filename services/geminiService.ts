import { GoogleGenAI } from "@google/genai";

const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });

export const getGeminiResponse = async (
  prompt: string, 
  history: { role: string; parts: { text: string }[] }[]
): Promise<string> => {
  try {
    const model = "gemini-2.5-flash";
    const systemInstruction = `
      أنت مساعد ذكي وخبير في "السدر الطبيعي" والعناية الشخصية لشركة "سدر الجوري".
      تتحدث اللغة العربية بطلاقة وأسلوبك مهذب، راقٍ، ومقنع.
      
      معلومات عن الشركة:
      - نبيع منتجات العناية الطبيعية المستخلصة من شجرة السدر المباركة.
      - منتجاتنا تشمل: ورق سدر مجفف، بودرة سدر مطحونة، زيت السدر، وشامبو السدر الطبيعي.
      - جميع منتجاتنا عضوية 100% وخالية من المواد الكيميائية الضارة.
      
      مجالات خبرتك:
      1. شجرة السدر (النبق): شجرة مباركة، فوائد أوراقها القديمة في الطب الشعبي والتجميلي.
      2. العناية بالشعر (السدر للشعر): 
         - يعمل كمنظف وشامبو طبيعي (رغوة السدر).
         - يقوي البصيلات، يكثف الشعر، ويمنع التساقط.
         - يعالج القشرة والحكة.
         - وصفات: سدر مع زبادي، سدر مع بصل وثوم (منقوع)، سدر مع زيوت.
      3. العناية بالبشرة (السدر للوجه والجسم):
         - تنظيف عميق للمسام وتقشير الجلد الميت.
         - توحيد لون البشرة وعلاج حب الشباب وآثاره.
         - شد البشرة ومحاربة التجاعيد.
         - الاغتسال بالسدر للجسم للطاقة والنظافة.
      
      مهامك:
      1. الإجابة على أسئلة الزوار حول فوائد السدر للشعر والبشرة.
      2. اقتراح وصفات طبيعية (ماسكات/خلطات) باستخدام بودرة وأوراق السدر.
      3. شرح طريقة استخدام المنتجات (مثل طريقة عجن السدر، مدة وضعه على الشعر).
      
      تنبيه: 
      - لا تتحدث عن العسل إطلاقاً، تركيزنا فقط على الأوراق والبودرة ومنتجات العناية.
      - لا تقدم نصائح طبية علاجية لأمراض خطيرة.
      - اجعل إجاباتك مختصرة ومفيدة (لا تزيد عن 3 فقرات).
    `;
    
    const chat = ai.chats.create({
      model: model,
      config: {
        systemInstruction: systemInstruction,
      },
      history: history.map(h => ({
        role: h.role,
        parts: h.parts
      }))
    });

    const result = await chat.sendMessage({ message: prompt });
    return result.text || "عذراً، لم أتمكن من الرد في الوقت الحالي.";
    
  } catch (error) {
    console.error("Gemini API Error:", error);
    return "عذراً، حدث خطأ تقني. يرجى المحاولة لاحقاً.";
  }
};